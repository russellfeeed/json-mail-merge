name: Playwright Tests (Standalone)

on:
  workflow_dispatch:  # Allow manual triggering
  schedule:
    - cron: '0 2 * * *'  # Run nightly at 2 AM UTC

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps
    
    - name: Build application
      run: npm run build
    
    - name: Run Playwright tests
      run: npm run test:e2e
    
    - name: Ensure artifact directories exist
      if: always()
      run: |
        mkdir -p playwright-report test-results
        echo "Created artifact directories"
    
    - name: List test artifacts
      if: always()
      run: |
        echo "Contents of playwright-report/:"
        if [ -d "playwright-report" ]; then
          ls -la playwright-report/
          find playwright-report -type f -name "*.html" -o -name "*.json" -o -name "*.png" | head -10
        else
          echo "playwright-report/ directory not found"
        fi
        echo "Contents of test-results/:"
        if [ -d "test-results" ]; then
          ls -la test-results/
          find test-results -type f -name "*.json" -o -name "*.png" -o -name "*.webm" | head -10
        else
          echo "test-results/ directory not found"
        fi
    
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30
        if-no-files-found: ignore